# Loathsxome plugin: metadata
# Abhijit Menon-Sen <ams@toroid.org>
# Based on the Blosxom plugin named meta by Rael Dornfest.
#
# Removes "meta: a=b" lines from the beginning of post bodies (until
# the first blank line) and stores the values as file properties.

package loathsxome::metadata;

sub start {
    1;
}

sub story {
    my ($pkg, $entry, $fname, $story, $title, $body) = @_;

    my ($b, $in_header) = ('', 1);
    foreach (split /\n/, $$body) {
        /^\s*$/ and $in_header = 0 and next;
        if ($in_header and my ($k, $v) = m{^meta: (\w+)=(.*)$}) {
            $loathsxome::entries{$entry}{meta}{$k} = $v;
            next;
        }
        $b .= $_ . "\n";
    }
    $$body = $b;
}

1;
